<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Configuración</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: transparent;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #fff;
  }

  body {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    min-height: 100vh;
    height: 100vh;
    padding: 24px;
    box-sizing: border-box;
    overflow: hidden;
  }

  #window {
    -webkit-app-region: no-drag;
    background: rgba(32, 32, 32, 0.95);
    border-radius: 12px;
    border: 2px solid rgba(255, 255, 255, 0.15);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1);
    padding: 24px;
    width: 508px;
    min-width: 508px;
    max-width: 508px;
    height: calc(100vh - 48px);
    min-height: calc(100vh - 48px);
    max-height: calc(100vh - 48px);
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.2) rgba(255, 255, 255, 0.05);
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  #window::-webkit-scrollbar {
    width: 12px;
  }

  #window::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    margin: 2px;
  }

  #window::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    border: 2px solid rgba(32, 32, 32, 0.95);
    background-clip: content-box;
  }

  #window::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
    background-clip: content-box;
  }

  #window::-webkit-scrollbar-thumb:active {
    background: rgba(255, 255, 255, 0.4);
    background-clip: content-box;
  }

  .header {
    -webkit-app-region: drag;
    position: sticky;
    top: 0;
    z-index: 5;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 16px;
    font-weight: 600;
    padding-bottom: 8px;
    margin-bottom: 8px;
    background: rgba(32, 32, 32, 0.95);
  }

  #closeSettings {
    -webkit-app-region: no-drag;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    color: #fff;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  #closeSettings:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .option {
    -webkit-app-region: no-drag;
    display: flex;
    align-items: flex-start;
    gap: 10px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 12px;
    font-size: 14px;
  }

  .option input {
    margin-top: 2px;
  }

  .option.option-column {
    flex-direction: column;
    align-items: stretch;
    gap: 8px;
  }

  .input-label {
    font-size: 13px;
    color: rgba(255, 255, 255, 0.85);
  }

  .number-input {
    -webkit-app-region: no-drag;
    width: 100%;
    padding: 8px 10px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    font-size: 14px;
    transition: all 0.2s ease;
    box-sizing: border-box;
  }

  .number-input:focus {
    border-color: #0078d4;
    background: rgba(255, 255, 255, 0.15);
    outline: none;
  }

  .section-title {
    -webkit-app-region: no-drag;
    font-size: 13px;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.85);
    margin-top: 4px;
  }

  #resetCountsBtn {
    -webkit-app-region: no-drag;
    width: 100%;
    padding: 10px 14px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  #resetCountsBtn:hover {
    background: rgba(255, 255, 255, 0.18);
    border-color: rgba(255, 255, 255, 0.25);
  }

  #resetCountsBtn:active {
    transform: scale(0.98);
  }

  .hint {
    -webkit-app-region: no-drag;
    user-select: text;
    font-size: 12px;
    opacity: 0.7;
    line-height: 1.4;
  }

  .confirm-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(6px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10;
    -webkit-app-region: no-drag;
  }

  .confirm-modal.show {
    display: flex;
  }

  .confirm-dialog {
    background: rgba(32, 32, 32, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    padding: 24px;
    width: 320px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
    display: flex;
    flex-direction: column;
    gap: 16px;
    -webkit-app-region: no-drag;
  }

  .confirm-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
  }

  .confirm-title {
    font-size: 16px;
    font-weight: 600;
  }

  .confirm-close {
    -webkit-app-region: no-drag;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    color: #fff;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .confirm-close:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .confirm-message {
    margin: 0;
    font-size: 14px;
    color: rgba(255, 255, 255, 0.8);
  }

  .confirm-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }

  .confirm-btn {
    -webkit-app-region: no-drag;
    padding: 8px 14px;
    border-radius: 6px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .confirm-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .confirm-btn.primary {
    background: #0078d4;
    border-color: #106ebe;
  }

  .confirm-btn.primary:hover {
    background: #106ebe;
  }
</style>
</head>
<body>
  <div id="window">
    <div class="header">
      <span>Configuración</span>
      <div id="closeSettings">✖</div>
    </div>
    <label class="option">
      <input type="checkbox" id="closeVirtualDisplay" />
      <span>Mantener aplicación abierta al cerrar display virtual</span>
    </label>
    <div class="hint">
      Esta preferencia se aplica cuando ejecutas aplicaciones desde el lanzador.
    </div>
    <label class="option">
      <input type="checkbox" id="turnScreenOffApps" />
      <span>Apagar pantalla al ejecutar aplicaciones</span>
    </label>
    <label class="option">
      <input type="checkbox" id="turnScreenOffMirror" />
      <span>Apagar pantalla al hacer mirror</span>
    </label>
    <label class="option">
      <input type="checkbox" id="preventDeviceSleep" />
      <span>Evitar que el dispositivo se duerma.</span>
    </label>
    <div class="hint">
      En algunos dispositivos, al bloquearse la pantalla, se detiene la conexión ADB. porque el dispositivo entra en estado de sueño. Activa esta casilla para evitar que el dispositivo se duerma.
    </div>
    <label class="option">
      <input type="checkbox" id="autoStartAudio" />
      <span>Activar audio al abrir una ventana/aplicación</span>
    </label>
    <div class="section-title">Video Bit Rate pantalla principal</div>
    <div class="option option-column">
      <label class="input-label" for="mirrorBitRate">Video Bit Rate para la pantalla principal (Mb/s)</label>
      <input type="number" id="mirrorBitRate" class="number-input" min="1" max="32" inputmode="numeric" />
      <div class="hint">
        Se aplica al botón Mirror. Usa un valor entre 1 y 32 Mb/s. Un valor mayor da una mejor calidad de imagen pero consume más recursos.
      </div>
    </div>
    <div class="section-title">Video Bit Rate aplicaciones lanzadas</div>
    <div class="option option-column">
      <label class="input-label" for="appBitRate">Video Bit Rate para aplicaciones lanzadas (Mb/s)</label>
      <input type="number" id="appBitRate" class="number-input" min="1" max="32" inputmode="numeric" />
      <div class="hint">
        Se aplica a las apps ejecutadas desde la lista. Usa un valor entre 1 y 32 Mb/s. Un valor mayor da una mejor calidad de imagen pero consume más recursos.
      </div>
    </div>
    <button id="resetCountsBtn" type="button">Resetear contador de apps más usadas</button>
  </div>

  <div id="confirmResetModal" class="confirm-modal" role="dialog" aria-modal="true" aria-labelledby="confirmResetTitle">
    <div class="confirm-dialog">
      <div class="confirm-header">
        <span id="confirmResetTitle" class="confirm-title">¿Resetear contador?</span>
        <button id="confirmResetClose" class="confirm-close" type="button" aria-label="Cerrar">✖</button>
      </div>
      <p class="confirm-message">¿Resetear contador?</p>
      <div class="confirm-actions">
        <button id="confirmResetYes" class="confirm-btn primary" type="button">Sí</button>
        <button id="confirmResetNo" class="confirm-btn" type="button">No</button>
      </div>
    </div>
  </div>

<script>
window.addEventListener('DOMContentLoaded', async () => {
  const checkbox = document.getElementById('closeVirtualDisplay');
  const turnScreenOffApps = document.getElementById('turnScreenOffApps');
  const turnScreenOffMirror = document.getElementById('turnScreenOffMirror');
  const preventDeviceSleep = document.getElementById('preventDeviceSleep');
  const autoStartAudio = document.getElementById('autoStartAudio');
  const closeBtn = document.getElementById('closeSettings');
  const mirrorBitRateInput = document.getElementById('mirrorBitRate');
  const appBitRateInput = document.getElementById('appBitRate');
  const resetCountsBtn = document.getElementById('resetCountsBtn');
  const confirmModal = document.getElementById('confirmResetModal');
  const confirmYes = document.getElementById('confirmResetYes');
  const confirmNo = document.getElementById('confirmResetNo');
  const confirmClose = document.getElementById('confirmResetClose');

  const windowElement = document.getElementById('window');
  const DRAG_THRESHOLD = 2;
  const dragExemptSelectors = [
    'button',
    'input',
    'textarea',
    'select',
    'a',
    'label',
    '#closeSettings',
    '.confirm-dialog',
    '.confirm-modal'
  ].join(', ');
  let isTrackingWindowDrag = false;
  let dragInitiated = false;
  let startDragScreenX = 0;
  let startDragScreenY = 0;
  let lastDragScreenX = 0;
  let lastDragScreenY = 0;
  let previousUserSelect = '';
  let suppressNextClick = false;
  let suppressClickTimeoutId = null;

  const canMoveWindow = () => typeof launcher !== 'undefined' && typeof launcher.moveWindow === 'function';

  function shouldSkipWindowDrag(target) {
    if (!windowElement) return true;
    const element = target instanceof Element ? target : target && target.parentElement;
    if (!element) return true;
    if (!windowElement.contains(element)) return true;
    if (element.closest(dragExemptSelectors)) return true;
    return false;
  }

  const handleWindowDragMove = (event) => {
    if (!isTrackingWindowDrag) return;
    if (!canMoveWindow()) {
      stopWindowDrag();
      return;
    }

    const deltaX = event.screenX - lastDragScreenX;
    const deltaY = event.screenY - lastDragScreenY;

    if (!dragInitiated) {
      const totalDeltaX = event.screenX - startDragScreenX;
      const totalDeltaY = event.screenY - startDragScreenY;
      if (Math.abs(totalDeltaX) < DRAG_THRESHOLD && Math.abs(totalDeltaY) < DRAG_THRESHOLD) {
        return;
      }
      dragInitiated = true;
    }

    if (deltaX === 0 && deltaY === 0) return;

    lastDragScreenX = event.screenX;
    lastDragScreenY = event.screenY;
    launcher.moveWindow(deltaX, deltaY);
  };

  const stopWindowDrag = () => {
    if (!isTrackingWindowDrag) return;
    isTrackingWindowDrag = false;
    window.removeEventListener('mousemove', handleWindowDragMove);
    window.removeEventListener('mouseup', stopWindowDrag);
    window.removeEventListener('blur', stopWindowDrag);
    document.removeEventListener('mouseleave', stopWindowDrag);
    if (document.body) {
      document.body.style.userSelect = previousUserSelect;
    }
    previousUserSelect = '';
    if (dragInitiated) {
      if (suppressClickTimeoutId) {
        clearTimeout(suppressClickTimeoutId);
      }
      suppressNextClick = true;
      suppressClickTimeoutId = window.setTimeout(() => {
        suppressNextClick = false;
        suppressClickTimeoutId = null;
      }, 120);
    }
    dragInitiated = false;
  };

  if (windowElement) {
    windowElement.addEventListener('mousedown', (event) => {
      if (event.button !== 0) return;
      if (!canMoveWindow()) return;
      if (shouldSkipWindowDrag(event.target)) return;
      if (isTrackingWindowDrag) return;
      isTrackingWindowDrag = true;
      dragInitiated = false;
      startDragScreenX = event.screenX;
      startDragScreenY = event.screenY;
      lastDragScreenX = event.screenX;
      lastDragScreenY = event.screenY;
      previousUserSelect = document.body ? (document.body.style.userSelect || '') : '';
      if (document.body) {
        document.body.style.userSelect = 'none';
      }
      window.addEventListener('mousemove', handleWindowDragMove);
      window.addEventListener('mouseup', stopWindowDrag);
      window.addEventListener('blur', stopWindowDrag);
      document.addEventListener('mouseleave', stopWindowDrag);
      event.preventDefault();
    });

    windowElement.addEventListener('click', (event) => {
      if (!suppressNextClick) return;
      if (suppressClickTimeoutId) {
        clearTimeout(suppressClickTimeoutId);
        suppressClickTimeoutId = null;
      }
      suppressNextClick = false;
      event.preventDefault();
      event.stopPropagation();
    }, true);
  }

  const DEFAULT_MIRROR_BIT_RATE = 10;
  const DEFAULT_APP_BIT_RATE = 8;

  const normalizeBitRate = (value, fallback) => {
    if (value === undefined || value === null) return fallback;
    const normalized = typeof value === 'string' ? value.trim() : value;
    if (normalized === '') return fallback;
    const number = Number(normalized);
    if (!Number.isFinite(number)) return fallback;
    const int = Math.round(number);
    if (int < 1) return 1;
    if (int > 32) return 32;
    return int;
  };

  const applySettings = (settings) => {
    const shouldClose = !settings || settings.closeOnVdClose !== false;
    if (checkbox) {
      checkbox.checked = shouldClose;
    }
    if (turnScreenOffApps) {
      turnScreenOffApps.checked = Boolean(settings && settings.turnScreenOffOnApps);
    }
    if (turnScreenOffMirror) {
      turnScreenOffMirror.checked = Boolean(settings && settings.turnScreenOffOnMirror);
    }
    if (preventDeviceSleep) {
      preventDeviceSleep.checked = !settings || settings.preventDeviceSleep !== false;
    }
    if (autoStartAudio) {
      autoStartAudio.checked = !settings || settings.autoStartAudio !== false;
    }
    const mirrorValue = normalizeBitRate(settings && settings.mirrorBitRate, DEFAULT_MIRROR_BIT_RATE);
    const appValue = normalizeBitRate(settings && settings.appBitRate, DEFAULT_APP_BIT_RATE);
    mirrorBitRateInput.value = mirrorValue;
    appBitRateInput.value = appValue;
  };

  if (typeof launcher !== 'undefined') {
    try {
      const settings = await launcher.getGlobalSettings();
      applySettings(settings);
    } catch (error) {
      console.error('No se pudieron cargar las preferencias:', error);
      applySettings();
    }
  } else {
    applySettings();
  }

  if (checkbox) {
    checkbox.addEventListener('change', async () => {
      if (typeof launcher !== 'undefined') {
        try {
          await launcher.updateGlobalSettings({ closeOnVdClose: checkbox.checked });
        } catch (error) {
          console.error('No se pudo guardar la preferencia:', error);
        }
      }
    });
  }

  if (turnScreenOffApps) {
    turnScreenOffApps.addEventListener('change', async () => {
      if (typeof launcher !== 'undefined') {
        try {
          await launcher.updateGlobalSettings({ turnScreenOffOnApps: turnScreenOffApps.checked });
        } catch (error) {
          console.error('No se pudo guardar la preferencia de apagado de pantalla para apps:', error);
        }
      }
    });
  }

  if (turnScreenOffMirror) {
    turnScreenOffMirror.addEventListener('change', async () => {
      if (typeof launcher !== 'undefined') {
        try {
          await launcher.updateGlobalSettings({ turnScreenOffOnMirror: turnScreenOffMirror.checked });
        } catch (error) {
          console.error('No se pudo guardar la preferencia de apagado de pantalla para mirror:', error);
        }
      }
    });
  }

  if (preventDeviceSleep) {
    preventDeviceSleep.addEventListener('change', async () => {
      if (typeof launcher !== 'undefined') {
        try {
          await launcher.updateGlobalSettings({ preventDeviceSleep: preventDeviceSleep.checked });
        } catch (error) {
          console.error('No se pudo guardar la preferencia de evitar sueño del dispositivo:', error);
        }
      }
    });
  }

  if (autoStartAudio) {
    autoStartAudio.addEventListener('change', async () => {
      if (typeof launcher !== 'undefined') {
        try {
          await launcher.updateGlobalSettings({ autoStartAudio: autoStartAudio.checked });
        } catch (error) {
          console.error('No se pudo guardar la preferencia de audio automático:', error);
        }
      }
    });
  }

  const persistBitRate = async (key, input, fallback) => {
    const value = normalizeBitRate(input.value, fallback);
    input.value = value;
    if (typeof launcher !== 'undefined') {
      try {
        await launcher.updateGlobalSettings({ [key]: value });
      } catch (error) {
        console.error(`No se pudo guardar ${key}:`, error);
      }
    }
  };

  const handleMirrorBitRateChange = () => persistBitRate('mirrorBitRate', mirrorBitRateInput, DEFAULT_MIRROR_BIT_RATE);
  const handleAppBitRateChange = () => persistBitRate('appBitRate', appBitRateInput, DEFAULT_APP_BIT_RATE);

  mirrorBitRateInput.addEventListener('change', handleMirrorBitRateChange);
  mirrorBitRateInput.addEventListener('blur', handleMirrorBitRateChange);
  appBitRateInput.addEventListener('change', handleAppBitRateChange);
  appBitRateInput.addEventListener('blur', handleAppBitRateChange);

  const closeConfirmModal = () => {
    confirmModal.classList.remove('show');
  };

  const openConfirmModal = () => {
    confirmModal.classList.add('show');
  };

  resetCountsBtn.addEventListener('click', openConfirmModal);

  confirmYes.addEventListener('click', async () => {
    if (typeof launcher !== 'undefined' && typeof launcher.resetAppCounts === 'function') {
      try {
        await launcher.resetAppCounts();
      } catch (error) {
        console.error('No se pudo resetear el contador:', error);
      }
    }
    closeConfirmModal();
  });

  confirmNo.addEventListener('click', closeConfirmModal);
  confirmClose.addEventListener('click', closeConfirmModal);

  confirmModal.addEventListener('click', (event) => {
    if (event.target === confirmModal) {
      closeConfirmModal();
    }
  });

  closeBtn.addEventListener('click', () => {
    window.close();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (confirmModal.classList.contains('show')) {
        e.preventDefault();
        closeConfirmModal();
      } else {
        e.preventDefault();
        window.close();
      }
    }
  });
});
</script>
</body>
</html>
